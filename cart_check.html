<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no"/>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">
    <title></title>
    <link rel="stylesheet" href="lib/ratchet/css/ratchet.css" type="text/css">
    <link rel="stylesheet" href="lib/weui.css" type="text/css">
    <link rel="stylesheet" href="css/app.css" type="text/css">

    <script src="lib/jquery-2.1.4.js"></script>
    <script src="lib/baiduTemplate.js"></script>
    <script src="lib/jquery-weui.js"></script>
    <script src="js/apiroute.js"></script>
    <script src="js/util.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/iscroll-lite.js"></script>
    <script src="js/mall.request.js"></script>
    <script src="js/app.js"></script>
</head>
<body>

<header class="bar bar-nav">
    <a class="icon icon-left-nav pull-left" id="navBackBtn"></a>
    <h1 class="title">填写订单</h1>
</header>

<!--TAB BAR-->
<nav class="bar bar-tab" id="mainTab">
    <a class="tab-item" id="mainTabHome" href="home.html">
        <span class="icon micon-home"></span>
        <span class="tab-label">首页</span>
    </a>
    <a class="tab-item" id="mainTabCate" href="goods.html">
        <span class="icon micon-cate"></span>
        <span class="tab-label">分类</span>
    </a>
    <a class="tab-item" id="mainTabCart" href="cart.html">
        <span class="icon micon-cart">
            <i class="badge badge-positive">0</i>
        </span>
        <span class="tab-label">购物车</span>
    </a>
    <a class="tab-item" id="mainTabUC" href="uc.html">
        <span class="icon micon-person"></span>
        <span class="tab-label">我的</span>
    </a>
</nav>
<!--TAB BAR END-->

<script type="text/html" id="tempDefAddress">
    <%if(data){%>
    <ul class="table-view">
        <li class="table-view-cell">
            <a href="address.html?mode=select" class="navigate-right">
                <span class="table-view-cell-title">收货地址</span>
                <div class="item-contact"><strong><%=data.contacts%></strong> <strong><%=data.phone%></strong></div>
                <div class="item-address"><%=data.province%> <%=data.city%> <%=data.county%> <%=data.street%></div>
            </a>
        </li>
    </ul>
    <%}else{%>
    <ul class="table-view">
        <li class="table-view-cell">
            <a href="address.html?mode=select" class="navigate-right">
                <span class="table-view-cell-title">收货地址</span>
                <span class="table-view-cell-value">请选择</span>
            </a>
        </li>
    </ul>
    <%}%>
</script>

<script type="text/html" id="tempGoodsCheckList">

</script>

<script type="text/html" id="tempBankForPay">
    <%if(data){%>
    <%for(var i=0;i < data.length ;i++){%>
    <li>
        <div>账户名称：<%=data[i].account_name%></div>
        <div>银行账号：<%=data[i].card_no%></div>
        <div>开户银行：<%=data[i].bank_name%></div>
    </li>
    <%}%>
    <%}%>
</script>

<div class="content content-cart-check" id="content-cart-check">

    <div class="mui-panel">
        <div class="mui-cart-address" id="containerDefAddress">

        </div>
        <input type="hidden" id="addressId" value=""/>
    </div>

    <div class="mui-panel">
        <div class="mui-cart-goods-checklist">
            <div class="items" id="containerGoodsCheckList">

            </div>
        </div>
    </div>

    <div class="mui-panel">
        <div class="" style="display: none;">
            <ul class="table-view">
                <li class="table-view-cell">
                    <a href="#" class="navigate-right">
                        <span class="table-view-cell-title">送货紧急度</span>
                        <span class="table-view-cell-value">不限制</span>
                    </a>
                </li>
            </ul>
        </div>
        <h2 class="mui-panel-title">送货紧急度</h2>
        <div class="mui-panel-content">
            <select class="f-control" id="delivery"></select>
        </div>
    </div>

    <div class="mui-panel">
        <div class="mui-cart-rank">
            <h2 class="mui-panel-title">配送信息</h2>
            <div class="mui-panel-content">
                <div id="delivery_info">配送时间：读取中...<br>
                    配送价格：读取中...
                </div>
            </div>
        </div>
    </div>

    <div class="mui-panel">
        <h2 class="mui-panel-title">物流公司</h2>
        <div class="mui-panel-content">
            <select class="f-control" onchange="" id="logistics"></select>
        </div>
    </div>


    <div class="mui-panel">
        <h2 class="mui-panel-title">支付方式</h2>
        <div class="mui-panel-content">
            <select class="f-control" id="payType"></select>
        </div>
        <div class="mui-bank-list">
            <ul id="bankForPay"></ul>
        </div>
    </div>


    <div class="mui-panel">
        <h2 class="mui-panel-title">红包</h2>
        <div class="mui-panel-content">
            <select class="f-control" onchange="javascript:selectCoupon();" id="coupon"></select>
        </div>
    </div>

    <div class="mui-panel">
        <div class="mui-cart-rank">
            <h2 class="mui-panel-title">备注</h2>
            <div class="mui-panel-content">
                <input class="f-control" id="memo" type="text">
            </div>
        </div>
    </div>

</div>

<div class="mui-cart-bar-footer">
    <div class="pull-left item-price">应付：<strong id="confirm-total"></strong> 元</div>
    <div class="pull-right item-btn">
        <button class="mui-btn-cart" id="submitOrderBtn">提交订单</button>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        $('title').text(getLocalCache('shopName'));

        var ccid = getLocalCache("ccid");
        var scid = getLocalCache("scid");
        var ticket = getLocalCache("ticket");
        //UI处理
        $("#mainTabCart").addClass("active");
        $("#navBackBtn").click(function () {
            history.go(-1);
        });

        $.showDefAddress("tempDefAddress", "containerDefAddress", ccid, "addressId");

        $.getCartInfo(scid, "delivery", 'payType', 'delivery_info');
        checkorder();

        $("#payType").change(function () {
            var type = $(this).val();
            if (type == 3 || type == 4) {
                $.payBank(scid, type, 'tempBankForPay', 'bankForPay');
            } else {
                $("#bankForPay").empty();
            }
        });

        $('#submitOrderBtn').click(function () {
            var cartMode = getUrlParam("mode") ? getUrlParam("mode") : ""; //获取购物车类型
            $.submitOrder(cartMode);
        });


        //绑定红包
        $.getCouponList("", "coupon", 3, false, false);

    });

    //选择红包
    function selectCoupon() {
        //如果选择了红包需要验证红包是否可以使用
        var cartMode = getUrlParam("mode") ? getUrlParam("mode") : ""; //获取购物车类型
        var coupon_id = $("#coupon").val();
        var gmoney = cart.getTotalMoney(cartMode);
        if (coupon_id > 0) {
            //验证该红包是否可用
            $.ajax({
                url: ROUTE_COUPON_CHECK,
                type: 'GET',
                cache: false,
                async: false,
                dataType: "jsonp",
                jsonp: 'callback',
                data: {
                    couid: coupon_id
                },
                success: function (data) {
                    if (data.status != 200) {
                        $.alert("该红包暂时不能使用");
                        return;
                    } else {
                        //金额需要减去红包金额
                        if (data.data != null && data.data.length > 0) {
                            //如果是按商品的红包则判断该红包能不能使用
                            var coupon_money = data.data[0].coupon_money;
                            var pay_money = 0;
                            if (gmoney > coupon_money) {
                                pay_money = gmoney - coupon_money;
                            } else {
                                pay_money = 0;
                            }
                            $("#confirm-total").html(pay_money.toFixed(2));
                        }
                    }
                },
                error: function () {

                }
            });
        } else {
            $("#confirm-total").html(gmoney);
        }
    }

    // 下单确认页面
    function checkorder() {
        var cartMode = getUrlParam("mode") ? getUrlParam("mode") : ""; //获取购物车类型

        var gtotal = cart.getCartTotal(cartMode);
        var gmoney = cart.getTotalMoney(cartMode);


        if (gtotal == 0) {
            $(".mui-empty").show();
            $(".cart-content").hide();
            $(".mui-cart-bar-footer").hide();
        } else {
            $(".mui-empty").hide();
            $(".cart-content").show();
            $(".mui-cart-bar-footer").show();
        }


        var cartobj = cart.displayCart(cartMode);

        console.log(cartobj);
        var items = cartobj.items;
        //console.log(items);
        var ct = $("#containerGoodsCheckList");
        ct.empty();

        for (var i = 0; i < items.length; ++i) {
            var item = items[i];
            var id = item.id;
            var product = item.product;
            var qty = item.qty;
            var price = cart._decimal(cart._accMul(item.price, qty), 2); //显示单品价格小计
            var img = item.img;
            var total = cart._decimal(cart._accMul(price, qty), 2);
            var marketid = item.marketid;

            var html_wrap = $('<div class="item-col"></div>');
            var html = $('<div class="item-goods"></div>');
            $('<input type="hidden" name="gid[]" value="' + id + '">').appendTo(html);
            $('<div class="item-gname">' + product + '</div><div class="item-total">×' + qty + '</div><div class="item-price-amount"><strong>' + price + '</strong> 元</div><ul class="giftlist" id="giveaway_' + id + '"></ul>').appendTo(html);
            //var sp = $('<div data-id="' + id + '" data-price="' + price + '" data-qty="' + qty + '" data-title="' + product + '" class=\"list-op cd-item-remove cd-img-replace cart-rm-cart\" ><span class="rsicon-remove"></span></div>');
            //sp.appendTo(html);

            html_wrap.append(html);
            $('<div class="goods-market" id="market_' + id + '"><ul></ul></div>').appendTo(html_wrap);
            html_wrap.appendTo(ct);
            //$("#totalGoods").html(gtotal);
            $("#confirm-total").html(gmoney);

            if (marketid != null || marketid != "undefined" || marketid.length > 0) {
                $.showItemMarketList(id, marketid);
            }
        }
    }

</script>

</body>
</html>